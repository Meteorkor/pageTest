<!doctype html>
<html lang="ko">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, shrink-to-fit=no">

</head>
<body>
<div id="map" style="width:100%;min-height:600px; height:100%;"></div>

<script
  src="https://code.jquery.com/jquery-1.12.4.min.js"
  integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
  crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=83bfuniegk&amp;submodules=panorama,geocoder,drawing,visualization"></script>
  <!--
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
  -->
<script id="code">
var store;
var request = false;

function getLocation() {
  if (navigator.geolocation) { // GPS를 지원하면
    navigator.geolocation.getCurrentPosition(function(position) {
      alert(position.coords.latitude + ' ' + position.coords.longitude);
    }, function(error) {
      console.error(error);
    }, {
      enableHighAccuracy: false,
      maximumAge: 0,
      timeout: Infinity
    });
  } else {
    alert('GPS를 지원하지 않습니다');
  }
}
//지도를 삽입할 HTML 요소 또는 HTML 요소의 id를 지정합니다.
var mapDiv = document.getElementById('map'); // 'map'으로 선언해도 동일

//옵션 없이 지도 객체를 생성하면 서울 시청을 중심으로 하는 16 레벨의 지도가 생성됩니다.
var map = new naver.maps.Map(mapDiv,{

center: new naver.maps.LatLng(37.3614483, 127.1114883)
});

naver.maps.Event.once(map, 'init_stylemap', function() {
var locationBtnHtml = '<a href="#" class="btn_mylct"><span class="spr_trff spr_ico_mylct">현재위치</span></a>';
	var customControl = new naver.maps.CustomControl(locationBtnHtml, {
        position: naver.maps.Position.TOP_LEFT
    });
	customControl.setMap(map);
	naver.maps.Event.addDOMListener(customControl.getElement(), 'click', function() {
	
		if (navigator.geolocation) { // GPS를 지원하면
			navigator.geolocation.getCurrentPosition(function(position) {
			  //alert(position.coords.latitude + ' ' + position.coords.longitude);
			  map.setCenter(new naver.maps.LatLng(position.coords.latitude, position.coords.longitude));
			}, function(error) {
			  console.error(error);
			}, {
			  enableHighAccuracy: false,
			  maximumAge: 0,
			  timeout: Infinity
			});
		  } else {
			alert('GPS를 지원하지 않습니다');
		  }
	
        //map.setCenter(new naver.maps.LatLng(37.3595953, 127.1053971));
    });
});


	function fetchInfo(lat,lng){
		//https://8oi9s0nnth.apigw.ntruss.com/corona19-masks/v1/storesByGeo/json?lat=37.35148745671425&lng=127.09941276992592&m=1200
		const URL = 'https://8oi9s0nnth.apigw.ntruss.com/corona19-masks/v1/storesByGeo/json?';

		var urlParam= "lat=" + lat + "&lng=" + lng + "&m=1200";

		const dupleChker = new Set();
		fetch(URL+urlParam)
		.then(function(response) {
			request = false;

		return response.json();
	  })
	  .then(function(myJson) {
		store = myJson.stores;
		myJson.stores.forEach((store)=>{
		
		//중복 처리
		if(dupleChker.has(store.code)){
			return ;
		}else{
			dupleChker.add(store.code);
		}
		
		var contentString = [
			'<div class="iw_inner">',
			'   <h3>'+store.name+'</h3>',
			'   <p>'+store.addr+'<br />',
			'  남은정도 : '+store.remain_stat+'<br>',
			'   </p>',
			'</div>'
		].join('');
		
		var infowindow = new naver.maps.InfoWindow({
			content: contentString
		});

		//"remain_stat": "empty","plenty","few","some"
		var color="";
		switch(store.remain_stat){
		case 'plenty':
			color = "green";
			break;
		case 'few':
		case 'some':
			color = 'yellow';
			break;
		default:
			color = 'red';
		}

			var localMarker = new naver.maps.Marker({
				position: new naver.maps.LatLng(store.lat, store.lng),
				icon: {
			content: [
						'<div class="cs_mapbridge" style="width:20px;height:20px;background:' + color + '">',
							'<div class="map_group _map_group crs">',
							'</div>',
						'</div>'
					].join(''),
			size: new naver.maps.Size(38, 58),
			anchor: new naver.maps.Point(19, 58),
		},
				map: map
			});
		naver.maps.Event.addListener(localMarker,"click",(e)=>{
		 if (infowindow.getMap()) {
				infowindow.close();
			} else {
				infowindow.open(map, localMarker);
			}
		});
		
		});
		
		//console.log(JSON.stringify(myJson));
		
	  });
	}


naver.maps.Event.addListener(map, "bounds_changed", function(bounds) {
	if(request!=true){
		console.log("map.getCenter() : " + map.getCenter());
		
		//거리 얼마 차이 안날때 호출 여부 추가해야됨
		fetchInfo(map.getCenter().lat(),map.getCenter().lng());
		request = true;
	}
	
});
</script>
</body>
</html>
